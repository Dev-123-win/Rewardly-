rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is the owner of a document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Users can only read and write their own data
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId);

      // Allow updates only with specific constraints
      allow update: if isOwner(userId) && (
        isCheckInUpdate() || isAdWatchUpdate()
      );

      // Validates a daily check-in update
      function isCheckInUpdate() {
        let incoming = request.resource.data;
        let existing = resource.data;
        let pointsEarned = incoming.points - existing.points;
        
        // Allow if: 
        // 1. lastCheckIn is being set to the current time.
        // 2. The streak is being incremented by 1 or reset to 1.
        // 3. Points are being incremented by a valid amount (base 10 + bonuses).
        return incoming.lastCheckIn == request.time &&
               (incoming.streak == existing.streak + 1 || incoming.streak == 1) &&
               (pointsEarned == 10 || pointsEarned == 30 || pointsEarned == 60 || pointsEarned == 110 || pointsEarned == 260);
      }

      // Validates a "Watch & Earn" update
      function isAdWatchUpdate() {
        let incoming = request.resource.data;
        let existing = resource.data;
        let cooldown = 30s; // 30 second cooldown

        // Allow if:
        // 1. lastAdWatchedTimestamp is being set to the current time.
        // 2. The cooldown period has passed.
        // 3. Points are being incremented by exactly 15.
        // 4. The daily ad count is being incremented by 1.
        return incoming.lastAdWatchedTimestamp == request.time &&
               request.time > existing.lastAdWatchedTimestamp + cooldown &&
               incoming.points == existing.points + 15 &&
               incoming.adsWatchedToday == existing.adsWatchedToday + 1;
      }
    }

    // Daily check-ins can only be created by the owner
    match /daily_check_ins/{checkInId} {
      allow read, create: if request.auth.uid == request.resource.data.userId;
    }
  }
}
